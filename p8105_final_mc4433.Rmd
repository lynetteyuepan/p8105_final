---
title: "P8105_final_mc4433"
author: "Manqi Cai"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#The relationship between gross at the opening week and total gross?
#The relationship between  gross at the opening week and director?

```{r packages, include=FALSE}

library(dplyr)
library(tidyverse)
library(httr)
library(rvest)
library(janitor)
library(stringr)
library(ggplot2)
library(hexbin)
library(plotly)
library(knitr)
library(DT)

```

# Prepare datasets
```{r data_prepare, include=FALSE}
# read IMDB data from Kaggle
movie = read.csv("./data/IMDB-Movie-Data.csv")

# read boxoffice data from internet
url_base = "http://www.boxofficemojo.com/yearly/chart/?view=releasedate&view2=domestic&yr="

# create url strings for 2006 - 2016 boxoffice data; only include movies with top 100 total gross in each year. 
urls = str_c(url_base, 2006:2016, "&sort=gross&order=DESC&p=.htm")
output = vector("list", 11)

# create for loop to generate the 2006 - 2016 boxoffice dataframe
boxoffice = NULL
for (i in 1:11) {

output[[i]] = read_html(urls[[i]])

output[[i]] %>% 
html_nodes(css = "table")

box_office_year = (output[[i]] %>% html_nodes(css = "table"))[[7]] %>%
  html_table(fill = TRUE) 
  
colnames(box_office_year) = box_office_year[1,]
colnames(box_office_year)[2] = "movie_title"
colnames(box_office_year)[3] = "studio"
colnames(box_office_year)[4] = "total_gross"
colnames(box_office_year)[5] = "theaters"
colnames(box_office_year)[6] = "opening"
colnames(box_office_year)[7] = "theaters_opening"  

box_office_year = box_office_year %>% 
  select(movie_title, studio, total_gross, opening) %>% 
  .[3:102,] %>%
  mutate(year = 2005 + i)
    
boxoffice = bind_rows(boxoffice, box_office_year)  
}
```

```{r combine and tidy dataset}
set.seed(1)
# renmae the movie_title in movie dataset in order to join two datasets
movie_rename= movie %>% 
  clean_names() %>% 
  rename("movie_title" = "title",
         "review_score" = "metascore")

# joining two datasets; tidy data set
movie_with_boxoffice = left_join(movie_rename, boxoffice, by=c("movie_title", "year")) %>% 
  rename("open_gross" = "opening")  

# Replace NA values in total_gross with the revenue column in movie dataset
total_gross_na = is.na(movie_with_boxoffice$total_gross)

movie_with_boxoffice$total_gross[total_gross_na] =  movie_with_boxoffice$revenue_millions[total_gross_na]*10^6

# eliminate $sign and "," of the total gross and open gross, remove rows with review scores is NA:
movie_with_boxoffice = movie_with_boxoffice %>% 
  mutate(total_gross = gsub("\\$", "", total_gross),
         total_gross = gsub(",", "", total_gross),
         total_gross = as.numeric(total_gross),
         open_gross = gsub("\\$", "", open_gross),
         open_gross = gsub(",", "", open_gross),
         open_gross = as.numeric(open_gross)) %>% 
  mutate(total_gross_millions = total_gross / 10^6,
         open_gross_millions = open_gross / 10^6,
         actors_sep = actors) %>% 
  select(-total_gross, -revenue_millions, -open_gross) %>% 
  separate(., actors_sep, c("actor1","actor2", "actor3", "actor4"), sep=",")


```

#develop relationship between open_gross and other possible indicators

```{r the top 10 highest open-gross movie}

movie_with_boxoffice %>%
  arrange(desc(open_gross_millions)) %>% 
  pull(movie_title)%>% 
  head(10)
```


##Is there a relationship between open gross and review score?
```{r}
set.seed(1)

# fit linear regression for total gross and review score
lm(open_gross_millions ~ review_score, data = movie_with_boxoffice) %>% 
  summary() %>% 
  broom::tidy() %>% 
  DT::datatable()

# visualize the linear regression 
movie_with_boxoffice %>% 
  na.omit() %>% 
  ggplot(aes(x= review_score, y = open_gross_millions)) +
  geom_point(alpha = .5) +
  stat_smooth(method = "lm") 

movie_with_boxoffice %>% 
  na.omit() %>% 
  group_by(year) %>% 
  ggplot(aes(x= review_score, y = open_gross_millions)) +
  geom_point(alpha = .5) +
  stat_smooth(method = "lm")+
  facet_grid(. ~ year)+
  theme(axis.text.x = element_text(angle = 90))

```

# Is there a relationship between open gross and genre?
```{r}
set.seed(1)

movie_with_boxoffice_genre_sep = movie_with_boxoffice %>%
  mutate(genre = as.character(genre)) %>% 
  tidytext::unnest_tokens(word, genre) %>% 
  mutate(genre = word) %>% 
  filter(!genre=="fi") %>% 
  mutate(genre = stringr::str_replace(genre, "sci", "sci-fi")) 

# check if genre is a significant predictor
anova(lm(open_gross_millions ~ genre, data = movie_with_boxoffice_genre_sep))

# fit linear regression for each genre
lm(open_gross_millions ~ genre, data = movie_with_boxoffice_genre_sep) %>% 
  summary() %>% 
  broom::tidy() %>% 
  filter(p.value < 0.05) %>% 
  datatable()

movie_with_boxoffice_genre_sep %>%   
  arrange(desc(open_gross_millions)) %>% 
  pull(genre) %>% 
  head(10)

  
movie_with_boxoffice_genre_sep %>% 
plot_ly(., x = ~genre,  y = ~open_gross_millions, color = ~genre, type = "box")


colors <- c('rgb(211,94,96)', 'rgb(128,133,133)', 'rgb(144,103,167)', 'rgb(171,104,87)', 'rgb(114,147,203)')

plot_ly(movie_with_boxoffice_genre_sep, labels = ~genre, values = ~open_gross_millions, type = 'pie',
        textposition = 'inside',
        textinfo = 'label+percent',
        insidetextfont = list(color = '#FFFFFF'),
        hoverinfo = 'text',
        text = ~paste('$', open_gross_millions, ' millions'),
        marker = list(colors = colors,
                      line = list(color = '#FFFFFF', width = 1)),
                      #The 'pull' attribute can also be used to create space between the sectors
        showlegend = FALSE) %>%
  layout(title = 'United States Personal Expenditures by Categories in 1960',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
  
```

### Is there a relationship between open gross and director?

```{r}
set.seed(1)

# check if director is a significant predictor
anova(lm(open_gross_millions ~ director, data = movie_with_boxoffice))
## significant

# fit linear regression for directors
lm(open_gross_millions ~ director, data = movie_with_boxoffice) %>% 
  summary() %>% 
  broom::tidy() %>% 
  filter(p.value < 0.5) %>% 
  DT::datatable() 

# visualize the relationship between total gross and 

movie_with_boxoffice %>% 
  plot_ly(x = ~director,  y = ~open_gross_millions, color = ~director, type = "box") %>% 
  layout(showlegend = FALSE)

movie_with_boxoffice %>% 
  arrange(desc(open_gross_millions)) %>% 
  pull(director) %>% 
  head(10)

```

### Is there a relationship between open gross and actor?
```{r}
set.seed(1)

# separate the actors in actor column into four columns; then use gather function in order to do the anova test.
movie_with_boxoffice_actor_combi= 
  movie_with_boxoffice %>%
  gather(., key = "num_actor", value = "main_actors", actor1:actor4)

# check if genre is a significant predictor
anova(lm(open_gross_millions ~ main_actors, data = movie_with_boxoffice_actor_combi))
## not significant


# visualize the relationship between total gross and 

movie_with_boxoffice_actor_combi %>% 
  plot_ly(x = ~main_actors,  y = ~open_gross_millions, color = ~main_actors, type = "box") %>% 
  layout(showlegend = FALSE)

movie_with_boxoffice_actor_combi %>%
  group_by(main_actors) %>% 
  arrange(desc(open_gross_millions)) %>% 
  head(10) %>% 
  select(movie_title, main_actors) %>% 
  knitr::kable()
  
```
