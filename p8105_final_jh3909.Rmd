---
title: "Review Scores"
author: "Jingxuan He"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---


```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE, warning=FALSE}
library(dplyr)
library(tidyverse)
library(httr)
library(rvest)
library(janitor)
library(stringr)
library(ggplot2)
library(hexbin)
library(plotly)
library(knitr)
library(DT)
```


```{r data_prepare, include=FALSE, warning=FALSE}
# read IMDB data from Kaggle
movie = read.csv("./data/IMDB-Movie-Data.csv")

# read boxoffice data from internet
url_base = "http://www.boxofficemojo.com/yearly/chart/?view=releasedate&view2=domestic&yr="

# create url strings for 2006 - 2016 boxoffice data; only include movies with top 100 total gross in each year. 
urls = str_c(url_base, 2006:2016, "&sort=gross&order=DESC&p=.htm")
output = vector("list", 11)

# create for loop to generate the 2006 - 2016 boxoffice dataframe
boxoffice = NULL
for (i in 1:11) {

output[[i]] = read_html(urls[[i]])

output[[i]] %>% 
html_nodes(css = "table")

box_office_year = (output[[i]] %>% html_nodes(css = "table"))[[7]] %>%
  html_table(fill = TRUE) 
  
colnames(box_office_year) = box_office_year[1,]
colnames(box_office_year)[2] = "movie_title"
colnames(box_office_year)[3] = "studio"
colnames(box_office_year)[4] = "total_gross"
colnames(box_office_year)[5] = "theaters"
colnames(box_office_year)[6] = "opening"
colnames(box_office_year)[7] = "theaters_opening"  

box_office_year = box_office_year %>% 
  dplyr::select(movie_title, studio, total_gross, opening) %>% 
  .[3:102,] %>%
  mutate(year = 2005 + i)
    
boxoffice = bind_rows(boxoffice, box_office_year)  
}
```

```{r, warning=FALSE}
set.seed(1)
# renmae the movie_title in movie dataset in order to join two datasets
movie_rename= movie %>% 
  clean_names() %>% 
  rename("movie_title" = "title",
         "review_score" = "metascore")

# joining two datasets; tidy data set
movie_with_boxoffice = left_join(movie_rename, boxoffice, by=c("movie_title", "year")) %>% 
  rename("open_gross" = "opening")  

# Replace NA values in total_gross with the revenue column in movie dataset
total_gross_na = is.na(movie_with_boxoffice$total_gross)

movie_with_boxoffice$total_gross[total_gross_na] =  movie_with_boxoffice$revenue_millions[total_gross_na]*10^6

# eliminate $sign and "," of the total gross and open gross, remove rows with review scores is NA:
movie_with_boxoffice = movie_with_boxoffice %>% 
  mutate(total_gross = gsub("\\$", "", total_gross),
         total_gross = gsub(",", "", total_gross),
         total_gross = as.numeric(total_gross),
         open_gross = gsub("\\$", "", open_gross),
         open_gross = gsub(",", "", open_gross),
         open_gross = as.numeric(open_gross)) %>% 
  mutate(total_gross_millions = total_gross / 10^6,
         open_gross_millions = open_gross / 10^6,
         actors_sep = actors,
         genre_sep = genre) %>% 
  select(-total_gross, -revenue_millions, -open_gross) %>% 
  separate(., actors_sep, c("actor1","actor2", "actor3", "actor4"), sep=",") %>% 
  separate(genre_sep, into = c("genre1", "genre2", "genre3"), sep = ",")



```






***

  
### Relationship between review score and box office
```{r, warning=FALSE}
set.seed(1)

movie_with_review_narm = 
  movie_with_boxoffice %>% 
  filter(!is.na(review_score)) 

# fit linear regression for review scoreand total gross
lm(review_score ~ total_gross_millions , data = movie_with_review_narm) %>% 
  summary() %>%
  broom::tidy() %>%
  datatable()
### significant

movie_with_review_narm %>% 
  ggplot(aes(x= total_gross_millions, y = review_score)) +
  geom_point(alpha = .5) +
  stat_smooth(method = "lm") +
  labs(title = "Association between Review Score and Total Gross" ,x = "Total Gross(Million)", y = "Review Score") + 
  theme(title = element_text(size = 14) ,text = element_text(size=15), axis.text.x = element_text(size = 15), legend.text = element_text(size = 15), legend.title = element_text(size = 15)) 
```

**Comment:**

* We can say that the positive association between review scores and boxoffice is significant. With every million increase in boxoffice, the expected review score will increase by 0.023 on average.


***
***


### Relationship between review score and genre
```{r, warning=FALSE}
set.seed(1)

# check if genre is a significant predictor
anova(lm(review_score ~ genre, data = movie_with_review_narm)) %>%
  broom::tidy() %>%
  datatable()
### significant

# fit linear regression for significant genre predictor
movie_with_review_narm %>%
  mutate(genre = as.character(genre)) %>% 
  tidytext::unnest_tokens(word, genre) %>% 
  mutate(genre = word) %>% 
  filter(!genre=="fi") %>% 
  mutate(genre = stringr::str_replace(genre, "sci", "sci-fi")) %>%
  lm(review_score ~ genre, .) %>% 
  broom::tidy() %>%
  filter(p.value < 0.05) %>%
  arrange(desc(estimate)) %>%
  datatable()

# visualize the relationship between total gross and 

movie_with_review_narm %>%
  mutate(genre = as.character(genre)) %>% 
  tidytext::unnest_tokens(word, genre) %>% 
  mutate(genre = word) %>% 
  filter(!genre=="fi") %>% 
  mutate(genre = stringr::str_replace(genre, "sci", "sci-fi")) %>%
  group_by(genre) %>%
  mutate(score_median = median(review_score)) %>%
  ungroup() %>%
  mutate(genre = forcats::fct_reorder(genre, score_median)) %>%
  plot_ly(., x = ~genre,  y = ~review_score, color = ~genre, type = "box") %>% 
  layout(xaxis = list(title = ""))
```

**Comment:**

*  The positive association between review scores and genre is significant. There are 12 types of genres are significant predictor for review score. Genres with top three high estimate of review scores are history, animation and biography.


***
***

### Relationship between review score and directors
```{r, warning=FALSE}
set.seed(1)

# check if director is a significant predictor

anova(lm(review_score ~ director, data = movie_with_review_narm)) %>%
  broom::tidy() %>%
  datatable()
## significant

# fit linear regression for significant director predictor
lm(review_score ~ director, data = movie_with_review_narm) %>% 
  broom::tidy() %>%
  filter(p.value < 0.05) %>%
  arrange(desc(estimate)) %>%
  datatable()

# visualize the relationship between total gross and 

movie_with_review_narm %>% 
  plot_ly(x = ~director,  y = ~review_score, color = ~director, type = "box") %>% 
  layout(showlegend = FALSE)
```

**Fun Finding! :**

*  Directors with top three high review scores are Barry Jenkins, Kenneth Lonergan and Todd Haynes. They directed Moonlight, Manchester by the Sea and Carol respectively, which are all movies with good reputation and been nominated by Oscar. It's not hard to think they have high review score! :)



***
***


### Relaitonship between review score and actors
```{r, warning=FALSE}
set.seed(1)

# separate the actors in actor column into four columns; then use gather function in order to do the anova test.
review_score_actor_sep= 
  movie_with_review_narm %>%
  gather(., key = "num_actor", value = "main_actors", actor1:actor4)

# check if actor is a significant predictor
anova(lm(review_score ~ main_actors, data = review_score_actor_sep)) %>%
  broom::tidy() %>%
  datatable()
## significant

# fit linear regression for significant director predictor
lm(review_score ~ main_actors, data = review_score_actor_sep) %>% 
  broom::tidy() %>%
  filter(p.value < 0.05) %>%
  arrange(desc(estimate)) %>%
  datatable()

# visualize the relationship between total gross and 

review_score_actor_sep %>% 
  plot_ly(x = ~main_actors,  y = ~review_score, color = ~main_actors, type = "box") %>% 
  layout(showlegend = FALSE)
```

**Comment:**

* Actors with top review scores mostly participated in good reputation movies like Boyhood, Moonlight. However, some of actors only have one movie in dataset, so that they might not be a accurate predictor for the review scores.


***
***


### Relationship between review score and film studio
```{r,  warning=FALSE}
set.seed(1)

# check if studio is a significant predictor
anova(lm(review_score ~ studio, data = movie_with_review_narm)) %>%
  broom::tidy() %>%
  datatable()
### significant

# fit linear regression for significant genre predictor
lm(review_score ~ studio, data = movie_with_review_narm) %>% 
  broom::tidy() %>%
  filter(p.value < 0.05) %>%
  arrange(desc(estimate)) %>%
  datatable()

# visualize the relationship between total gross and 

movie_with_review_narm %>% 
  plot_ly(., x = ~studio,  y = ~review_score, color = ~studio, type = "box")
```

**Fun Finding! :**

*  It is surprising that top film studios like Warner Bros and Universal Studio have are negatively associated with review score, which means if the film is made by these film, it may have a lower review score! The reason behind this phenomenon may be top studios produce hundreds of movie each year and not all of them got good reputaion, which lower the eastimate of review scores.


