---
title: "p8105_hw5_yx2450"
output: html_document
---

```{r results='hide', message=FALSE, warning=FALSE}
library(readr)
library(tidyverse)
library(tidytext)
library(rvest)
library(httr)
library(janitor)
library(haven)
library(stringr)
library(forcats)
library(viridis)
theme_set(theme_bw())
theme_update(legend.position = "bottom")
```

##Problem 1
```{r}
##read and clean data 
nyc_subway = GET("https://data.ny.gov/resource/hvwh-qtfg.csv", query = list(`$limit` = 2000),col_names = cols()) %>% 
  content("parsed") %>% 
  clean_names() %>% 
  select(station_name, entrance_latitude, entrance_longitude, east_west_street, north_south_street, corner)
```

###Make a plot
```{r}
nyc_subway %>% 
  group_by(station_name) %>% 
  summarize(entrance_number = n()) %>% 
  filter(entrance_number > 10) %>% 
  mutate(station_name = fct_reorder(station_name,entrance_number)) %>% 
  ggplot(aes(x = station_name, y = entrance_number)) +
  geom_bar(stat = "identity", fill = "blue", alpha = .5) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("Number of Entrances for Each Subway Station") 
```

###"St"
```{r}
nyc_subway %>% 
  filter(str_detect(station_name,regex("St"))) %>% 
  group_by(station_name) %>% 
  summarise(n = n()) %>% 
  nrow()

nyc_subway %>% 
  filter(str_detect(station_name, regex("St$"))) %>% 
  group_by(station_name) %>% 
  summarise(n = n()) %>% 
  nrow()
```

##Problem 2
###Find and tidy data
```{r}
url = "https://en.wikipedia.org/wiki/List_of_Game_of_Thrones_episodes"
game_of_throne_xml = read_html(url)

table_GOT = (game_of_throne_xml %>% html_nodes(css = "table"))[[10]] %>% 
  html_table()

GOT_data = table_GOT %>% 
  clean_names() %>% 
  select(-season, -average) %>% 
  rename(season = season_2) %>% 
  gather(key = "episode", value = "viewers", ep_1:ep_10) %>% 
  mutate(episode = str_replace(episode, "ep_10", "_E10"), 
         episode = str_replace(episode, "ep_", "_E0")) %>%
  mutate(episode_id = str_c("S",season,episode)) %>% ##str_c:concatenate
  mutate(episode = as.numeric(substr(episode,3,4))) %>% 
  filter(!viewers == "N/A") 
```

###Make a plot
```{r}
GOT_data %>% 
  mutate(viewers = as.numeric(viewers)) %>% 
  ggplot(aes(x = episode_id, y = viewers, fill = season))+
  geom_bar(stat = "identity") +
   theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("Number of Viewers for Each Episode of Each Season") +
  ylab("viewers(millions)")

```

###Make a boxplot
```{r}
GOT_data %>% 
  mutate(viewers = as.numeric(viewers),
         season = factor(season),
         season = fct_recode(season,
                             "season_1" = "1",
                             "season_2" = "2",
                             "season_3" = "3",
                             "season_4" = "4",
                             "season_5" = "5",
                             "season_6" = "6",
                             "season_7" = "7")) %>%
  ggplot(aes(x = season, y = viewers)) + 
  geom_boxplot(aes(fill = season)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("Number of Viewers for Each Episode of Each Season") +
  ylab("viewers(millions)")
```

###Linear model
```{r}
#Fit a linear model that treats number of viewers in each episode as a response and season as a categorical predictor; make season 4 the reference season. Present and discuss the results of your modeling.
GOT_data %>% 
    mutate(season = factor(season),
         season = fct_relevel(season, "4")) %>% 
  lm(viewers ~ season, data = .) %>% 
  broom::tidy() %>% 
  select(-std.error, -statistic) %>% 
  knitr::kable(digits = 3)
```

From the model we can know that there is positive linear association between season 5,6,7 and viewers when we make season 4 as reference season, and season 7 have the most positive association with viewers.
There is negative linear assoication between season 1,2,3 and viewers when we have the same reference group, and season 1 have the most negative association.  

##Problem 3

###Inspect and describe dataset
```{r}
dynamite_reviews = read.csv ("../data/dynamite_reviews.csv") %>% 
  clean_names() %>% 
  str()
```
There are three variables included: stars, title and text.

###Tidy data and remove stop words

```{r}
dynamite_reviews = read.csv ("../data/dynamite_reviews.csv") %>% 
  clean_names() %>% 
  filter(stars %in% c("5", "4", "3","2","1")) %>% 
  mutate(inspection_num = row_number()) %>%
  mutate(text = as.character(text)) %>% 
  select(stars,title,text,inspection_num)

inspection_words = dynamite_reviews %>% 
  unnest_tokens(word, text)

data(stop_words)

inspection_words = anti_join(inspection_words, stop_words)
```

###Most frequent word
```{r}
##5-star review
inspection_words %>% 
  filter(stars == "5") %>% 
  count(word, sort = TRUE) %>% 
  top_n(1) 
##1-star review
inspection_words %>% 
  filter(stars == "1") %>% 
  count(word, sort = TRUE) %>% 
  top_n(1) 
```

###Make plot
```{r}
word_ratios = inspection_words %>% 
  filter(stars %in% c("1", "5")) %>% 
  count(word, stars) %>% 
  spread(stars, n, fill = 0) %>%
  rename(one_star = "1", five_star = "5") %>%
  mutate(
    one_star_odds = (one_star + 1) / (sum(one_star) + 1),
    five_star_odds = (five_star + 1) / (sum(five_star) + 1),
    log_OR = log(one_star_odds / five_star_odds)
  ) %>%
  arrange(desc(log_OR))
  
word_ratios %>%
  mutate(pos_log_OR = ifelse(log_OR > 0, "one_star > five_star", "five_star > one_star")) %>% 
  group_by(pos_log_OR) %>%
  top_n(10, abs(log_OR)) %>%
  ungroup() %>%
  mutate(word = fct_reorder(word, log_OR)) %>%
  ggplot(aes(word, log_OR, fill = pos_log_OR)) +
  geom_col() +
  coord_flip() +
  ylab("log odds ratio (one_star/five_star)") +
  scale_fill_discrete(name = "") +
  ggtitle("Log Odds Ratio for Word Appearance")
```

###Sentiment analysis
```{r}
bing_sentiments = get_sentiments("bing")

inspection_sentiments = inspection_words %>% 
  inner_join(., bing_sentiments) %>% 
  count(inspection_num, sentiment) %>% 
  spread(sentiment, n, fill = 0) %>% 
  mutate(sentiment = positive - negative) %>% 
  select(inspection_num, sentiment)

inspection_sentiments = 
  right_join(dynamite_reviews, inspection_sentiments, 
             by = "inspection_num")

set.seed(1)

inspection_sentiments %>% 
  mutate(inspection_num = factor(inspection_num),
    inspection_num = fct_reorder(inspection_num, sentiment)) %>% 
  ggplot(aes(x = inspection_num, 
             y = sentiment, fill = stars, color = stars)) + 
  geom_bar(stat = "identity") + 
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  scale_fill_viridis(discrete = FALSE) + 
  scale_color_viridis(discrete = FALSE) 
```

###Most positive 
```{r}
inspection_sentiments %>% 
  filter(min_rank(desc(sentiment)) < 2)
```

###Most negative
```{r}
inspection_sentiments %>% 
  filter(min_rank(sentiment) < 2)
```

